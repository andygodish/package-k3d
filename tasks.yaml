includes:
  - minio: tasks/minio.yaml

variables:
  - name: K3D_REGISTRY
    description: "Remote OCI registry for UDS K3d package"
    default: "ghcr.io/defenseunicorns/packages"
  - name: K3D_PACKAGE_NAME
    description: "Name of the UDS K3d package"
    default: "uds-k3d"
  - name: K3D_PACKAGE_VERSION
    description: "Version of the UDS K3d package"
    default: "0.19.5"
  - name: ARCHITECTURE
    description: "System architecture (amd64 or arm64)"
    default: ""
  - name: CONFIG_FILE
    description: "Path to the zarf config file"
    default: "zarf-config.toml"

tasks:
  - name: pull
    description: "Pull UDS K3d package from OCI registry"
    actions:
      - description: "Pull UDS K3d package from OCI registry"
        cmd: |
          echo "Pulling UDS K3d package ${K3D_PACKAGE_NAME}:${K3D_PACKAGE_VERSION} from ${K3D_REGISTRY}"
          
          ARCH_FLAG=""
          if [ -n "${ARCHITECTURE}" ]; then
            ARCH_FLAG="-a ${ARCHITECTURE}"
            echo "Using specified architecture: ${ARCHITECTURE}"
          else
            echo "Using auto-detected architecture"
          fi
          
          uds zarf package pull ${ARCH_FLAG} oci://${K3D_REGISTRY}/${K3D_PACKAGE_NAME}:${K3D_PACKAGE_VERSION}
        env:
          - ZARF_LOG_LEVEL=info

  - name: deploy
    description: "Deploy K3d cluster with development settings"
    actions:
      - description: "Deploy K3d cluster with root zarf-config.toml"
        cmd: |
          ZARF_CONFIG="$CONFIG_FILE" uds zarf package deploy zarf-package-uds-k3d-*-${K3D_PACKAGE_VERSION}.tar.zst \
            --confirm

  - name: clean
    description: "Remove local UDS K3d package files"
    actions:
      - description: "Clean up local K3d package files"
        cmd: |
          echo "Cleaning up local UDS K3d package files"
          rm -f zarf-package-uds-k3d*.tar.zst
          echo "Package files removed"

  - name: setup-zarf-registry-minio-backend
    description: "Set up MinIO backend for the zarf registry to use as a backend"
    actions: 
      - task: minio:port-forward
      - task: minio:configure-alias
      - task: minio:create-bucket
        with:
          alias: local
          bucket: zarf-registry
      - task: minio:create-policy
        with:
          alias: local
          policy: zarf-registry-policy
          file: zarf-registry-policy.json
      - task: minio:create-user
        with:
          alias: local
          username: zarf-registry
          secret: zarf-registry-secret
      - task: minio:attach-policy-to-user
        with:
          alias: local
          policy: zarf-registry-policy
          username: zarf-registry
